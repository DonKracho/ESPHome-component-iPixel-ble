esphome:
  name: ipixel-ble
  friendly_name: LED Pixel Board
  libraries:
    - https://github.com/donkracho/ErriezCRC32

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: esp-idf

# Enable logging ESP32 C3 reuses UART0
logger:
  baud_rate: 115200
  hardware_uart: UART0
  level: debug

# Enable Home Assistant API
api:
  encryption:
    key: !secret esphome_encryption_key

ota:
  - platform: esphome
    password: !secret esphome_ota_key

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
external_components:
#  - source: github://DonKracho/ESPHome-external-component-for-iPixel-ble-devices/components
  - source: D:\ESPHome-external-component-for-iPixel-ble-devices\components
    refresh: 0s
    components: [ipixel_ble]

# Include custom fonts
font:
  - file: "gfonts://Roboto"
    id: roboto
    size: 16

# required by ble_client    
esp32_ble_tracker:

ble_client:
  id: ble_client_id
  mac_address: 0F:D6:54:F9:D2:C7

ipixel_ble:
    id: ipixel_ble_id
    ble_client_id: ble_client_id

display:
  - platform: ipixel_ble
    rotation: 0
    #width: 32   # use a fixed value if device recognition fails
    #height: 32  # use a fixed value if device recognition fails
    lambda: |-
      auto red = Color(255, 0, 0);
      auto green = Color(0, 255, 0);
      auto blue = Color(0, 0, 255);
      auto black = Color(0, 0, 0);
      auto white = Color(255, 255, 255);
      int8_t page = id(slot_number).state; 
      switch (page) {
      case 1:
        // to test some graphic functions draw a smiley
        it.filled_circle(15, 15, 14, Color(255, 255, 0));
        it.line(8, 20, 24, 20, red);
        it.line(10, 21, 22, 21, red);
        it.line(12, 22, 20, 22, red);
        it.rectangle( 0, 0, 32, 32, blue);
        it.filled_circle(9, 9, 5, white);
        it.filled_circle(22, 9, 5, white);
        it.filled_circle(10, 10, 2, Color(0, 0, 0));
        it.filled_circle(23, 10, 2, Color(0, 0, 0));
        break;
      case 2:
        it.filled_rectangle(0, 0, 32, 7, red);
        it.print(it.get_width()/2, it.get_height()/2, id(roboto), white, TextAlign::CENTER, id(text_id).state.c_str());
        it.filled_rectangle(0, 24, 32, 7, red);
        break;
      default:
        it.filled_ring(15, 15, 10, 14, green);
        it.printf(it.get_width()/2, it.get_height()/2, id(roboto), white, TextAlign::CENTER, "%d", page);
        break;
      }

light:
  - platform: ipixel_ble
    id: control_id
    name: Control
    default_transition_length: 0s
    initial_state:
      state: ON
    restore_mode: RESTORE_DEFAULT_ON
    effects:
      - lambda:
          name: Time
          lambda: |-
            id(control_id).set_flash_transition_length(1);
      - lambda:
          name: Time & Date
          lambda: |-
            id(control_id).set_flash_transition_length(2);
      - lambda:
          name: Message
          lambda: |-
            id(control_id).set_flash_transition_length(3);
      - lambda:
          name: Load PNG
          lambda: |-
            id(control_id).set_flash_transition_length(4);
      - lambda:
          name: Load Lambda
          lambda: |-
            id(control_id).set_flash_transition_length(5);
      - lambda:
          name: Fill Color
          lambda: |-
            id(control_id).set_flash_transition_length(6);
      - lambda:
          name: Fill Rainbow
          lambda: |-
            id(control_id).set_flash_transition_length(7);
      - lambda:
          name: Random Pixels
          lambda: |-
            id(control_id).set_flash_transition_length(8);
      - lambda:
          name: Alarm
          lambda: |-
            id(control_id).set_flash_transition_length(9);

sensor:
  - platform: ipixel_ble
    connect_state:
      name: "Connect State"
      id: connect_state
      icon: mdi:bluetooth
    display_width:
      name: "Display Width"
      id: display_width
      icon: mdi:arrow-expand-horizontal
    display_height:
      name: "Display Height"
      id: display_height
      icon: mdi:arrow-expand-vertical
    font_width:
      name: "Font Width"
      id: font_width
      icon: mdi:arrow-left-right
    font_height:
      name: "Font Height"
      id: font_height
      icon: mdi:arrow-up-down
    orientation:
      name: "Orientation"
      id: orientation
      icon: mdi:screen-rotation
    fun_mode:
      name: "Fun Mode"
      id: fun_mode
      icon: mdi:emoticon-outline

number:
  - platform: ipixel_ble
    clock_style:
      name: "Clock style"
      id: clock_style
      icon: mdi:clock-digital
    slot_number:
      name: "Slot Number"
      id: slot_number
      icon: mdi:numeric-1-box-multiple-outline
    annimation_mode:
      name: "Annimation Mode"
      id: annimation_mode
      icon: mdi:animation-outline
    annimation_speed:
      name: "Annimation Speed"
      id: annimation_speed
      icon: mdi:play-speed
    font_flag:
      name: "Font Flag"
      id: font_flag
      icon: mdi:format-size
    text_mode:
      name: "Text Mode"
      id: text_mode
      icon: mdi:palette

button:
  - platform: ipixel_ble
    delete_slot:
      name: "Delete Slot"
      id: delete_slot_button
      internal: true
    update_time:
      name: "Update Time"
      id: update_time_button

switch:
  - platform: ipixel_ble
    play:
      name: "Play"
      id: play_switch
      internal: true

text:
  - platform: ipixel_ble
    name: Data
    id: data_id
    mode: text
    #optimistic: true
    icon: "mdi:keyboard-settings-outline"
    #just for testing lambda prints
  - platform: template 
    name: Lambda
    id: text_id
    mode: text
    initial_value: "Hi5"
    optimistic: true
    icon: "mdi:keyboard-settings-outline"

time:
  - platform: homeassistant
    id: homeassistant_time

# do not use until the device has at least 8MB flash available 
#http_request:
  
#online_image:
#  - url: "https://images.icon-icons.com/1533/PNG/512/3338076-emoji-face-smiley-surprised_106819.png"
#    id: image_id
#    format: PNG
#    type: RGB
#    resize: 32x32
#    on_download_finished:
#      component.update: ipixel_ble_id
